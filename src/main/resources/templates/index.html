<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–æ–π</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üíá –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä—Å–∫–æ–π</h1>
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <strong th:text="${currentUser?.username}"></strong></span>
                <span class="role-badge" th:text="${currentUser?.role}"></span>
                <form th:action="@{/logout}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-small btn-secondary">–í—ã–π—Ç–∏</button>
                </form>
            </div>
            <nav class="tabs">
                <button class="tab-btn" th:classappend="${activeTab == 'services'} ? 'active'" 
                        sec:authorize="hasAnyRole('ADMIN', 'CLIENT')"
                        onclick="switchTab('services')">–£—Å–ª—É–≥–∏</button>
                <button class="tab-btn" th:classappend="${activeTab == 'masters'} ? 'active'"
                        sec:authorize="hasRole('ADMIN')"
                        onclick="switchTab('masters')">–ú–∞—Å—Ç–µ—Ä–∞</button>
                <button class="tab-btn" th:classappend="${activeTab == 'appointments'} ? 'active'"
                        onclick="switchTab('appointments')">–ó–∞–ø–∏—Å–∏</button>
                <button class="tab-btn" th:classappend="${activeTab == 'users'} ? 'active'" sec:authorize="hasRole('ADMIN')"
                        onclick="switchTab('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button class="tab-btn" th:classappend="${activeTab == 'reports'} ? 'active'" sec:authorize="hasRole('ADMIN')"
                        onclick="switchTab('reports')">–û—Ç—á—ë—Ç—ã</button>
                <button class="tab-btn" onclick="location.href='/about'">–û–± –∞–≤—Ç–æ—Ä–µ</button>
            </nav>
        </header>

        <main>
            <!-- –í–∫–ª–∞–¥–∫–∞ –£—Å–ª—É–≥–∏ -->
            <div id="services" class="tab-content" th:classappend="${activeTab == 'services'} ? 'active'">
                <h2>üìã –°–ø–∏—Å–æ–∫ —É—Å–ª—É–≥</h2>
                
                <div class="actions">
                    <div class="search-sort">
                        <input type="text" id="search-services" placeholder="–ü–æ–∏—Å–∫ —É—Å–ª—É–≥..." 
                               th:value="${search}" onkeyup="searchServices()">
                        <select id="sort-services" onchange="sortServices()">
                            <option value="name,asc" th:selected="${sortBy == 'name' && order == 'asc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ù–∞–∑–≤–∞–Ω–∏–µ (–ê-–Ø)</option>
                            <option value="name,desc" th:selected="${sortBy == 'name' && order == 'desc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ù–∞–∑–≤–∞–Ω–∏–µ (–Ø-–ê)</option>
                            <option value="price,asc" th:selected="${sortBy == 'price' && order == 'asc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
                            <option value="price,desc" th:selected="${sortBy == 'price' && order == 'desc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
                            <option value="duration,asc" th:selected="${sortBy == 'duration' && order == 'asc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</option>
                            <option value="duration,desc" th:selected="${sortBy == 'duration' && order == 'desc'}">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</option>
                        </select>
                    </div>
                    <div class="buttons" sec:authorize="hasRole('ADMIN')">
                        <button class="btn btn-primary" onclick="showAddServiceForm()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button>
                        <button class="btn btn-secondary" onclick="exportData('services', 'json')">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                    </div>
                </div>

                <!-- –¢–∞–±–ª–∏—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–¶–µ–Ω–∞ (‚ÇΩ)</th>
                                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="service : ${services}">
                                <td th:text="${service.id}"></td>
                                <td th:text="${service.name}"></td>
                                <td th:text="${service.description ?: '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}"></td>
                                <td th:text="${#numbers.formatDecimal(service.price, 0, 'COMMA', 2, 'POINT')}"></td>
                                <td th:text="${service.duration}"></td>
                                <td sec:authorize="hasRole('ADMIN')">
                                    <button class="btn btn-small btn-primary" th:onclick="'editService(' + ${service.id} + ')'">‚úèÔ∏è</button>
                                    <button class="btn btn-small btn-danger" th:onclick="'deleteService(' + ${service.id} + ')'">üóëÔ∏è</button>
                                </td>
                                <td sec:authorize="!hasRole('ADMIN')">
                                    <span class="text-muted">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ú–∞—Å—Ç–µ—Ä–∞ -->
            <div id="masters" class="tab-content" th:classappend="${activeTab == 'masters'} ? 'active'">
                <h2>üë®‚Äçüíº –ú–∞—Å—Ç–µ—Ä–∞</h2>
                <div class="actions" sec:authorize="hasRole('ADMIN')">
                    <button class="btn btn-primary" onclick="showAddMasterForm()">+ –î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è</th>
                                <th>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</th>
                                <th>–°—Ç–∞–∂ (–ª–µ—Ç)</th>
                                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="master : ${masters}">
                                <td th:text="${master.id}"></td>
                                <td th:text="${master.name}"></td>
                                <td th:text="${master.specialization ?: '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}"></td>
                                <td th:text="${master.experience}"></td>
                                <td>‚≠ê <span th:text="${master.rating}"></span></td>
                                <td sec:authorize="hasRole('ADMIN')">
                                    <button class="btn btn-small btn-primary" th:onclick="'editMaster(' + ${master.id} + ')'">‚úèÔ∏è</button>
                                    <button class="btn btn-small btn-danger" th:onclick="'deleteMaster(' + ${master.id} + ')'">üóëÔ∏è</button>
                                </td>
                                <td sec:authorize="!hasRole('ADMIN')">
                                    <span class="text-muted">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–ø–∏—Å–∏ -->
            <div id="appointments" class="tab-content" th:classappend="${activeTab == 'appointments'} ? 'active'">
                <h2>üìÖ –ó–∞–ø–∏—Å–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
                <div class="actions">
                    <input type="text" id="search-appointments" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∫–ª–∏–µ–Ω—Ç–∞, –º–∞—Å—Ç–µ—Ä–∞..." onkeyup="searchAppointments()">
                    <button class="btn btn-primary" th:if="${currentUser?.role == '–ö–ª–∏–µ–Ω—Ç' || currentUser?.role == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}" onclick="showAddAppointmentForm()">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ú–∞—Å—Ç–µ—Ä</th>
                                <th>–£—Å–ª—É–≥–∞</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="apt : ${appointments}">
                                <td th:text="${apt.id}"></td>
                                <td th:text="${usersMap.get(apt.clientId) ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}"></td>
                                <td th:text="${mastersMap.get(apt.masterId) ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}"></td>
                                <td th:text="${servicesMap.get(apt.serviceId) ?: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}"></td>
                                <td th:text="${#temporals.format(apt.date, 'dd.MM.yyyy')}"></td>
                                <td th:text="${#temporals.format(apt.time, 'HH:mm')}"></td>
                                <td>
                                    <span class="status-badge" 
                                          th:classappend="${apt.status == '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞'} ? 'status-planned' : 
                                                          (${apt.status == '–í—ã–ø–æ–ª–Ω–µ–Ω–∞'} ? 'status-completed' : 'status-cancelled')"
                                          th:text="${apt.status}"></span>
                                </td>
                                <td>
                                    <span th:if="${apt.status == '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞'}">
                                        <!-- –ú–∞—Å—Ç–µ—Ä –∏ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–≥—É—Ç –æ—Ç–º–µ—á–∞—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é -->
                                        <button class="btn btn-small btn-success" 
                                                th:if="${currentUser?.role == '–ú–∞—Å—Ç–µ—Ä' || currentUser?.role == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}"
                                                th:onclick="'completeAppointment(' + ${apt.id} + ')'">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–∞</button>
                                        <!-- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞–ø–∏—Å–∏, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –ª—é–±—ã–µ -->
                                        <button class="btn btn-small btn-danger" 
                                                th:if="${(currentUser?.role == '–ö–ª–∏–µ–Ω—Ç' && apt.clientId == currentUser?.id) || currentUser?.role == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'}"
                                                th:onclick="'cancelAppointment(' + ${apt.id} + ')'">‚úó –û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div id="users" class="tab-content" th:classappend="${activeTab == 'users'} ? 'active'" sec:authorize="hasRole('ADMIN')">
                <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
                <div class="actions">
                    <button class="btn btn-primary" onclick="showAddUserForm()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                                <th>–†–æ–ª—å</th>
                                <th>Email</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}"></td>
                                <td th:text="${user.username}"></td>
                                <td><span class="role-badge" th:text="${user.role}"></span></td>
                                <td th:text="${user.email}"></td>
                                <td th:text="${user.phone ?: '–ù–µ —É–∫–∞–∑–∞–Ω'}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –û—Ç—á—ë—Ç—ã -->
            <div id="reports" class="tab-content" th:classappend="${activeTab == 'reports'} ? 'active'" sec:authorize="hasRole('ADMIN')">
                <h2>üìä –û—Ç—á—ë—Ç—ã</h2>
                <div class="actions">
                    <button class="btn btn-primary" onclick="showGenerateReportForm()">üìà –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–ª–∏–µ–Ω—Ç–æ–≤</th>
                                <th>–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="report : ${reports}">
                                <td th:text="${report.id}"></td>
                                <td th:text="${#temporals.format(report.reportDate, 'dd.MM.yyyy')}"></td>
                                <td th:text="${report.totalClients}"></td>
                                <td th:text="${#numbers.formatDecimal(report.totalIncome, 0, 'COMMA', 2, 'POINT')}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>

    <script th:inline="javascript">
        // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ JavaScript
        /*[# th:if="${currentUser != null}"]*/
        window.currentUser = {
            id: /*[[${currentUser.id}]]*/ null,
            role: /*[[${currentUser.role}]]*/ '',
            username: /*[[${currentUser.username}]]*/ ''
        };
        /*[/]*/
        /*[# th:if="${currentUser == null}"]*/
        window.currentUser = null;
        /*[/]*/
    </script>
    <script src="/js/app.js"></script>
</body>
</html>

